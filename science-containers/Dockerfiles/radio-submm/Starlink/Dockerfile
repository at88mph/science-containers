# Build file for ORACDR [JCMT data processing environment]
#HK updated to Ubuntu22.04
FROM images.canfar.net/skaha/ubuntu:22.04 AS deploy
# make sure we get manual pages

RUN apt-get update

#(only install packages not already included in harbor version of this container
RUN apt install -y libvshadow-utils python3-pip libgfortran-10-dev \
	glibc-source glibc-tools
#RUN yum install -y epel-release


# system settings and permissions
COPY src/nofiles.conf /etc/security/limits.d/
COPY src/nsswitch.conf /etc/
## see https://bugzilla.redhat.com/show_bug.cgi?id=1773148
RUN touch /etc/sudo.conf && echo "Set disable_coredump false" > /etc/sudo.conf

#HK: come back to this one!!
RUN pip install setuptools

#RUN curl https://ftp.eao.hawaii.edu/starlink/2023A/starlink-2023A-Linux-Ubuntu22.tar.gz | tar xzf -
ADD starlink-2023A-Linux-Ubuntu22.tar /opt

#Additional libraries/packages found lacking after initial build & test
RUN apt install -y libpng-dev


#Additional font packages that are needed for gaia, etc
# (list courtesy of Peter Draper. Gaia will not display without these)
#RUN yum install -y xorg-x11-fonts-100dpi-7.2-11.el6.noarch
#RUN yum install -y xorg-x11-fonts-ISO8859-1-75dpi-7.2-11.el6.noarch
#RUN yum install -y xorg-x11-fonts-Type1-7.2-11.el6.noarch
#RUN yum install -y xorg-x11-fonts-ISO8859-1-100dpi-7.2-11.el6.noarch
#RUN yum install -y xorg-x11-fonts-misc-7.2-11.el6.noarch
#RUN yum install -y xorg-x11-font-utils-7.2-11.el6.x86_64
RUN apt install -y x11proto-fonts-dev


# Add some stuff to make the UNIX environment a bit nicer
#RUN apt install -y emacs
#RUN apt install -y moreutils
#RUN apt install -y man-pages
#RUN yum install -v -y man

ENV STARLINK_DIR=/opt/star-2023A

# Fifth try, JJ suggestion
COPY src/starlink.sh /etc/profile.d/
COPY src/startup.sh /skaha/startup.sh
RUN chmod +x /skaha/startup.sh

#HK addition for python wrapper (Sarah Greaves at EAO)
#(1st line from googling on what to do with error message generated by 2nd)
#(Sept 2024: this is no longer installing, unsure about current error messages)
#RUN pip install pyopenssl ndg-httpsclient pyasn1 numpy
#RUN pip install starlink-pywrapper


# Two build sets, deploy and test
FROM deploy as test
RUN echo "Adding a test user to run local testing"
RUN mkdir -p /arc/home
RUN groupadd -g 1001 testuser
RUN useradd -u 1001 -g 1001 -s /bin/bash -d /arc/home/testuser -m testuser
ENTRYPOINT ["/skaha/startup.sh"]


